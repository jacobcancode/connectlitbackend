{% extends "layouts/base.html" %}
{% set project = "Login" %}

{% block body %}
    <!-- Start of body content specific to page -->
    <div class="px-5 py-5 mx-auto">
        <div class="container py-4">
            <header class="pb-3 mb-4 border-bottom border-primary text-light">
                <span class="fs-4">Login Page</span>
            </header>
        </div>
    
        <div class="container py-4 text-light bg-primary">
    
            <div class="container bg-secondary py-4">
                <div class="p-5 mb-4 bg-light text-dark rounded-3">
                    <form id="loginForm" name="f" action="{{ url_for('login') }}" method="POST">
                        <table>
                            {% if error %}
                                <tr class="alert alert-danger">
                                    <td colspan="2">{{ error }}</td>
                                </tr>
                            {% endif %}
                            <tr><th><label for="username">User ID</label></th></tr>
                            <tr><td><input id='username' name="username" size="20" required></td></tr>
                            <tr><th><label for="password">Password</label></th></tr>
                            <tr><td><input type="password" id="password" name="password" size="20" required></td></tr>
                            <!-- Hidden input for 'next' page, which is set on unauthorized redirects -->
                            <input type="hidden" name="next" value="{{ next }}">
                            <tr><th><input type="submit" value="Submit"></th></tr>
                        </table>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const next = document.querySelector('input[name="next"]').value;
            
            try {
                const response = await fetch('/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username,
                        password: password,
                        next: next
                    })
                });

                const data = await response.json();
                
                if (response.ok && data.token) {
                    // Store the token in localStorage for API requests
                    localStorage.setItem('jwt_token', data.token);
                    
                    // Redirect to the next page or home
                    window.location.href = next || '/';
                } else {
                    // Show error message
                    const errorRow = document.querySelector('.alert-danger');
                    if (errorRow) {
                        errorRow.textContent = data.error || 'Login failed';
                    }
                }
            } catch (error) {
                console.error('Login Error:', error);
                const errorRow = document.querySelector('.alert-danger');
                if (errorRow) {
                    errorRow.textContent = 'An error occurred during login';
                }
            }
        });
    </script>
{% endblock %}